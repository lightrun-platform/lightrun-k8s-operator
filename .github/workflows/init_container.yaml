name: "Init container for k8s operator"

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag of the agent'     
        required: true
      init_image_tag:
        description: 'Image tag'  
        required: true
        default: "0"



jobs:  
  set_image_tag_variable:
    strategy:
      matrix:
        agents: [
          {file: "agent.zip", platform: "linux"},
          {file: "agent-alpine.zip", platform: "alpine"}
        ]
    runs-on: ubuntu-latest
    name: Build and push Docker image
    steps:
    - name: Set release tag
      shell: bash
      run: |
          echo "::set-output name=TAG_NAME::$(echo ${{ inputs.release_tag }} | sed -E 's/^([0-9]*\.[0-9]*\.[0-9]*).*/\1/')-init.${{ inputs.init_image_tag }}"
      id: set_tag

    - uses: actions/checkout@v3


    - name: Login to DockerHub
      if: ${{ success() }}
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKERHUB_USER }}
        password: ${{ secrets.DOCKERHUB_PASS }}
    

    - name: Configure AWS credentials for artifacts bucket
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: ${{ secrets.RELEASE_ARTIFACTS_MANAGER_KEY }}
        aws-secret-access-key: ${{ secrets.RELEASE_ARTIFACTS_MANAGER_SECRET }}
        aws-region: us-east-1

    - name: Set docker image tags
      run: |
        pip install semver==3.0.1
        existing_tags=$(aws s3 ls --output json s3://${{ secrets.RELEASE_ARTIFACTS_BUCKET }}/artifacts/ | grep PRE | awk '{if (NR!=1) {print substr($2, 1, length($2)-1)}}')
        for tag in $existing_tags
        do
          if [[ $(pysemver compare $tag ${{steps.set_tag.outputs.TAG_NAME}}) > 0 ]] ; then
            echo "$tag is greater than ${{ inputs.release_tag }}. Stopping"
            echo "::set-output name=DOCKER_TAGS::"lightruncom/k8s-operator-init-java-agent-${{ matrix.agents.platform }}:${{steps.set_tag.outputs.TAG_NAME}}"
            exit 0
          fi
          echo "Adding latest tag to ${{steps.set_tag.outputs.TAG_NAME}} "
          echo "::set-output name=DOCKER_TAGS::lightruncom/k8s-operator-init-java-agent-${{ matrix.agents.platform }}:${{steps.set_tag.outputs.TAG_NAME}},lightruncom/k8s-operator-init-java-agent-${{ matrix.agents.platform }}:latest"
        done

    - name: Download agent artifacts
      run: |
        aws s3 cp s3://${{ secrets.RELEASE_ARTIFACTS_BUCKET }}/artifacts/${{ inputs.release_tag }}/${{ matrix.agents.file }} ./lightrun-init-agent/


    - name: Build and push ${{ matrix.agents.platform }} container
      uses: docker/build-push-action@v4
      with:
        context: .
        file: ./lightrun-init-agent/Dockerfile
        push: true
        tags: ${{steps.set_tag.outputs.DOCKER_TAGS}}
        build-args: |
          FILE=${{ matrix.agents.file }}


    - name: Slack Notification
      if: always()
      uses: rtCamp/action-slack-notify@v2.2.0
      env:
        SLACK_CHANNEL: devops-alerts
        SLACK_COLOR: ${{ job.status }} # or a specific color like 'good' or '#ff00ff'
        SLACK_MESSAGE: 'Tag ${{ inputs.release_tag }} | Platform ${{ matrix.agents.platform }}'
        SLACK_TITLE: Init contianer build status - ${{ job.status }}
        SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}